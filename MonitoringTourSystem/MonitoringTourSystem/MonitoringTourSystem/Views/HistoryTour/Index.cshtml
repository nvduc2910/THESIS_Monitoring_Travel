
@model MonitoringTourSystem.ViewModel.TourDetailViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Lịch Sử Tour";
}
<title>@ViewBag.Title</title>
<link href="~/Content/DropdowSelect/select2.min.css" rel="stylesheet" />
<script src="~/Content/DropdowSelect/select2.min.js" type="text/javascript"></script>
<script src="~/Scripts/TourDetail/tourdetail.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.js"></script>
<script type="text/javascript" src="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/src/js/bootstrap-datetimepicker.js"></script>
<link href="~/Content/DropdowSelect/select2.min.css" rel="stylesheet" />
<script src="~/Content/DropdowSelect/select2.min.js" type="text/javascript"></script>
<link href="~/Scripts/TourDetail/css/timelineSchedule.css" rel="stylesheet" />
<script src="~/Scripts/TourDetail/tourdetail.js"></script>
<link rel="stylesheet" type="text/css" href="https://eonasdan.github.io/bootstrap-datetimepicker/css/prettify-1.0.css">
<link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/build/css/bootstrap-datetimepicker.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" src="~/Scripts/sweetalert-dev.js"></script>
<link rel="stylesheet" href="~/Scripts/sweetalert.css" />

<div id="main-content" style="background-color: white; height: 100%;">
    <div class="wrapper" style="background-color: white; padding-top: 15px;">
        <div class='row' style="height: 100%; width: 100%; margin: 0px;">
            <div class="col-sm-4" style="height:100%;">
                <header class="panel-heading" style="border: 1px solid #EAEBED; height: 14%">
                    <h3>Danh sách tour</h3>
                </header>
                <div class="panel-body" style="background-color: white; border: 1px solid #EAEBED;">
                    <ul class="nav nav-tabs" style="margin-top: 0px;">
                        <li class="active"><a data-toggle="tab" href="#home" style="color: #1FB5AD">Trong Nước</a></li>
                        <li><a data-toggle="tab" href="#menu1" style="color: #1FB5AD">Ngoài Nước</a></li>
                    </ul>
                    <div class="tab-content">
                        <div id="home" class="tab-pane fade in active">
                            <div style="padding-left: 0px; padding-right: 0px; margin-top: 10px;">
                                <div id="searchform">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Tìm kiếm tour theo mã..." id="nametourVietNam" onkeyup="searchTour();" name="query" value="">
                                        <div class="input-group-btn">
                                            <button type="submit" id="Search" class="btn">
                                                <i class="fa fa-search" style="color: gray" aria-hidden="true"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="input-group" style="margin-top: 10px; width: 100%;">
                                        <div class="input-group date datepicker_end">
                                            <input class="form-control" id="daysearch" type="text" placeholder="Tìm theo ngày" name="mytext[]">
                                            <span class="input-group-addon">
                                                <span class="glyphicon glyphicon-calendar"></span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="input-group" style="margin-top: 10px; width: 100%;">
                                        <select id="region" style="width: 70%; margin-right: 10px; height: 34px; border-radius: 4px;">
                                            <option style="font-size: 18px;" value="0" disabled selected>Chọn miền</option>


                                        </select>
                                        <button type="button" class="btn btn-primary" style="width: 25%; float: right" onclick="searchWithDateAndTown();">Tìm</button>
                                    </div>
                                    <div class="alert alert-success" style="margin-top: 10px;">
                                        Danh sách.
                                    </div>
                                </div>
                            </div>
                            <div id="group-list-tour" style="height: 100%; margin-top: -20px">
                                @{
                                    Html.RenderPartial("ListTourVietNam", Model);
                                }
                            </div>
                            <style>
                                ul.list-tour, ul.list-tour li ul.sub {
                                    margin: -2px 0 0;
                                    padding: 0;
                                }

                                ul.list-tour {
                                    padding-top: 0px;
                                }

                                ul.list-tour li {
                                    border-bottom: 1px dotted #d7d7d7;
                                }

                                ul.list-tour li a {
                                    color: gray;
                                    text-decoration: none;
                                    display: block;
                                    padding: 18px 0 18px 12px;
                                    font-size: 14px;
                                    outline: none;
                                    -webkit-transition: all 0.3s ease;
                                    -moz-transition: all 0.3s ease;
                                    -o-transition: all 0.3s ease;
                                    -ms-transition: all 0.3s ease;
                                    transition: all 0.3s ease;
                                }

                                ul.list-tour li a i {
                                    font-size: 15px;
                                    padding-right: 6px;
                                }

                                ul.list-tour li a span {
                                    display: inline-block;
                                }

                                ul.list-tour, ul.list-tour li ul.sub {
                                    margin: -2px 0 0;
                                    padding: 0;
                                }

                                ul.list-tour li ul.sub li {
                                    margin-bottom: 0;
                                    margin-left: 0px;
                                    margin-right: 0;
                                }

                                ul.list-tour li ul.sub li a {
                                    font-size: 12px;
                                    padding-top: 13px;
                                    padding-bottom: 13px;
                                    -webkit-transition: all 0.3s ease;
                                    -moz-transition: all 0.3s ease;
                                    -o-transition: all 0.3s ease;
                                    -ms-transition: all 0.3s ease;
                                    transition: all 0.3s ease;
                                    color: #aeb2b7;
                                }
                            </style>
                        </div>
                        <div id="menu1" class="tab-pane fade">
                            <div style="padding-left: 0px; padding-right: 0px; margin-top: 10px;">
                                <div id="searchform">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Tìm kiếm tour theo mã..." id="nametourForeign" onkeyup="searchTourForeign();" name="query" value="">
                                        <div class="input-group-btn">
                                            <button type="submit" id="Search" class="btn">
                                                <i class="fa fa-search" style="color: gray" aria-hidden="true"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="group-list-tour" style="height: 77%;">
                                @{
                                    Html.RenderPartial("ListTourForeign", Model);
                                }
                            </div>
                            <style>
                                ul.list-tour, ul.list-tour li ul.sub {
                                    margin: -2px 0 0;
                                    padding: 0;
                                }

                                ul.list-tour {
                                    padding-top: 0px;
                                }

                                ul.list-tour li {
                                    border-bottom: 1px dotted #d7d7d7;
                                }

                                ul.list-tour li a {
                                    color: gray;
                                    text-decoration: none;
                                    display: block;
                                    padding: 18px 0 18px 12px;
                                    font-size: 14px;
                                    outline: none;
                                    -webkit-transition: all 0.3s ease;
                                    -moz-transition: all 0.3s ease;
                                    -o-transition: all 0.3s ease;
                                    -ms-transition: all 0.3s ease;
                                    transition: all 0.3s ease;
                                }

                                ul.list-tour li a i {
                                    font-size: 15px;
                                    padding-right: 6px;
                                }

                                ul.list-tour li a span {
                                    display: inline-block;
                                }

                                ul.list-tour, ul.list-tour li ul.sub {
                                    margin: -2px 0 0;
                                    padding: 0;
                                }

                                ul.list-tour li ul.sub li {
                                    margin-bottom: 0;
                                    margin-left: 0px;
                                    margin-right: 0;
                                }

                                ul.list-tour li ul.sub li a {
                                    font-size: 12px;
                                    padding-top: 13px;
                                    padding-bottom: 13px;
                                    -webkit-transition: all 0.3s ease;
                                    -moz-transition: all 0.3s ease;
                                    -o-transition: all 0.3s ease;
                                    -ms-transition: all 0.3s ease;
                                    transition: all 0.3s ease;
                                    color: #aeb2b7;
                                }
                            </style>
                        </div>
                        <div id="menu2" class="tab-pane fade">
                            <h3>Menu 2</h3>
                            <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam.</p>
                        </div>
                        <div id="menu3" class="tab-pane fade">
                            <h3>Menu 3</h3>
                            <p>Eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-8" style="height:100%;">
                <div class="panel-body" style="background-color: white; border: 1px solid #EAEBED;">
                    <div class='row'>
                        <div class='col-md-12'>
                            <ul class='nav nav-pills'>
                                <li class='active'>
                                    <a data-toggle='tab' href='#vis_opgave2'>Lịch sử hành trình</a>

                                </li>
                                <li>
                                    <a data-toggle='tab' href='#rediger_opgave2'>Thông tin</a>

                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="tab-content">
                        <div id='vis_opgave2' class='tab-pane fade in active' style="height: 600px">
                            <input id="pac-input" class="controls" type="text"  placeholder="Tìm địa điểm" style="font-family: Roboto,Arial,sans-serif; border-radius: 4px;font-size: 12px; display: none">
                            <div id="map" style="height: 600px; position: relative; overflow: hidden; margin-top: 22px;"> </div>
                        </div>
                        <div id='rediger_opgave2' class='tab-pane fade'>
                            <div id="tour-details" class="panel-body" style="background-color: white; border: 1px solid #EAEBED; height: 75%; margin-top: 20px;">
                                @{
                                    Html.RenderPartial("ScheduleTourTimeline", Model);
                                }
                            </div>
                            <style>
                                div.list-tour {
                                    padding-top: 15px;
                                    padding-bottom: 15px;
                                }

                                div.list-tour {
                                    border-bottom: 1px solid #d7d7d7;
                                }
                            </style>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var marker1;
        var map1;
        var geocoder;
        var infowindow;
        var _mapPoints = [];
        var listMarkerRoute = [];
        var flightPath;
        function initMap() {
        //var map;
        //var marker = null;
        //map = new google.maps.Map(document.getElementById('map'), {
        //    center: {lat: 0, lng: 0},
        //    zoom: 1
        //});
        //google.maps.event.addListener(map, "click", function (e) {
        //    var latLng = e.latLng;
        //    if (marker){
        //        marker.setMap(null);
        //    }
        //    marker = new google.maps.Marker({
        //        position: {lat: latLng.lat(), lng: latLng.lng()},
        //        map: map
        //    });

        //    $('#lat').val(latLng.lat());
        //    $('#lang').val(latLng.lng());
        //});

        map1 = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 10.823099, lng: 106.629664 },
            zoom: 12,
            mapTypeId: 'roadmap'
        });

        geocoder = new google.maps.Geocoder;
        infowindow = new google.maps.InfoWindow;

        google.maps.event.addListener(map1, "click", function (event) {

            placeMarker(event.latLng);
            var latitude = event.latLng.lat();
            var longitude = event.latLng.lng();
            geocodeLatLng(geocoder, map1, infowindow, latitude, longitude);

            $('#lat').val(latitude);
            $('#lang').val(longitude);

            //myHub.server.updateLocation(location);
        });
        // Create the search box and link it to the UI element.
        var input = document.getElementById('pac-input');
        var searchBox = new google.maps.places.SearchBox(input);
        map1.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

        // Bias the SearchBox results towards current map's viewport.
        map1.addListener('bounds_changed', function () {
            searchBox.setBounds(map1.getBounds());
        });

        var markers = [];
        // Listen for the event fired when the user selects a prediction and retrieve
        // more details for that place.
        searchBox.addListener('places_changed', function () {
            var places = searchBox.getPlaces();

            if (places.length == 0) {
                return;
            }

            // Clear out the old markers.
            markers.forEach(function (marker1) {
                marker.setMap(null);
            });
            markers = [];

            // For each place, get the icon, name and location.
            var bounds = new google.maps.LatLngBounds();
            places.forEach(function (place) {
                if (!place.geometry) {
                    console.log("Returned place contains no geometry");
                    return;
                }
                infowindow.close();
                placeMarker(place.geometry.location);
                // Create a marker for each place.


                if (place.geometry.viewport) {
                    // Only geocodes have viewport.
                    bounds.union(place.geometry.viewport);
                } else {
                    bounds.extend(place.geometry.location);
                }
            });
            map1.fitBounds(bounds);
        });
    }

        function placeMarker(location) {

        var latMarker = location.toString().replace("(", "").replace(")", "").split(",")[0];
        var longMarker = location.toString().replace("(", "").replace(")", "").split(",")[1];
        if (marker1) {

            marker1.setPosition(location);

        } else {
            marker1 = new google.maps.Marker({
                position: location,
                map: map1
            });
        }
    }
        function geocodeLatLng(geocoder, map, infowindow, latClick, longClick) {

        var latlng = { lat: latClick, lng: longClick };
        geocoder.geocode({ 'location': latlng }, function (results, status) {
            if (status === 'OK') {
                if (results[1]) {
                    //
                    infowindow.setContent(results[1].formatted_address);
                    $('#address').val(results[1].formatted_address);
                    infowindow.open(map1, marker1);
                } else {
                    //window.alert('No results found');
                }
            } else {
                //window.alert('Geocoder failed due to: ' + status);
            }
        });
        }
        function getHistoryTour(id) {

            _mapPoints = [];
            for (i = 0; i < listMarkerRoute.length; i++) {
                listMarkerRoute[i].setMap(null);
            }
            listMarkerRoute = [];
            if (flightPath != null) {
                flightPath.setMap(null);
            }

            $.ajax({

                url: "/HistoryTour/GetPointLocation/" + id,
                type: "GET",
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                async: true,
                processData: false,
                cache: false,
                success: function (result) {
                    var results = $.parseJSON(result);
                    $(results).each(function (index, value) {

                        var longitude = this['longitude'];
                        var latitude = this['latitude'];
                        var point = new google.maps.LatLng(latitude, longitude);
                        _mapPoints.push(point);
                    });

                    flightPath = new google.maps.Polyline({
                        path: _mapPoints,
                        geodesic: true,
                        strokeColor: '#FF0000',
                        strokeOpacity: 1.0,
                        strokeWeight: 2
                    });

                    flightPath.setMap(map1);

                    var pinImageStart = {
                        url: '/Content/Images/ic_flag_start.png', // image is 512 x 512
                        scaledSize: new google.maps.Size(40, 40)
                    };

                    var pinImageStop = {
                        url: '/Content/Images/ic_flag_destination.png', // image is 512 x 512
                        scaledSize: new google.maps.Size(40, 40)
                    };

                    listMarkerRoute[0] = new google.maps.Marker({
                        position: _mapPoints[0],
                        map: map1,
                        animation: google.maps.Animation.Gp,
                        icon: pinImageStart,
                    })

                    listMarkerRoute[1] = new google.maps.Marker({
                        position: _mapPoints[_mapPoints.length - 1],
                        map: map1,
                        animation: google.maps.Animation.Gp,
                        icon: pinImageStop,
                    })

                    map1.setCenter(_mapPoints[0]);
                    //map1.zoom = 8;


                    GetTourDetail(0);
                },
                error: function (xhr) {
                    alert('Error get history');
                }
            });
        }

        function GetTourDetail(id) {
            $.ajax({
                url: "/HistoryTour/GetDetailTour/" + id,
                type: "GET",
            })
            .done(function (partialViewResult) {
                $("#tour-details").html(partialViewResult);
            });
        }
        function searchTour() {
            var id = $('#nametourVietNam').val();
            $("#list-tour-vietnam").html("<img src='/Content/loading.gif' style='display: block; margin: auto;'> ");
            $.ajax({
                url: "/HistoryTour/SearchTourVietNam/" + id,
                type: "GET",
            })
            .done(function (partialViewResult) {
                $("#list-tour-vietnam").html(partialViewResult);

            });
        }

        function searchTourForeign() {
            var id = $('#nametourForeign').val();
            $("#list-tour-foreign").html("<img src='/Content/loading.gif' style='display: block; margin: auto;'> ");
            $.ajax({
                url: "/HistoryTour/SearchTourForeign/" + id,
                type: "GET",
            })
            .done(function (partialViewResult) {
                $("#list-tour-foreign").html(partialViewResult);

            });
        }

        function searchWithDateAndTown() {
            var dayValue = $("#daysearch").val();
            var region = $("#region").val();

            $("#list-tour-vietnam").html("<img src='/Content/loading.gif' style='display: block; margin: auto;'> ");
            $.ajax({
                url: "/HistoryTour/SearchByDateAndTown",
                type: "POST",
                data:
                    {
                        regionSearch: region,
                        dateSearch: dayValue,
                    },
            })
            .done(function (partialViewResult) {
                $("#list-tour-vietnam").html(partialViewResult);
            });
        }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGdBwIy95layOTnAy1Ovp07urh0OxQrp4&libraries=places&callback=initMap" async defer></script>


</div>
